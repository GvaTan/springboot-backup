/**
 * 
 */
package top.anets.utils;

import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStreamWriter;
import java.net.URISyntaxException;
import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.Timer;
import java.util.TimerTask;

import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.stereotype.Component;

import com.google.gson.Gson;

import top.anets.payTest.VxCofig;

/**
 * @author Administrator
 *
 */
@Component
public class PayInit implements ApplicationRunner{

	@Override
	public void run(ApplicationArguments args) throws Exception {
		System.out.println("helloe");
		//初始化方法，新建立一个定时器
    	Timer timer = new Timer();
    	SimpleDateFormat format =new SimpleDateFormat("yyyy-MM-dd hh:mm:ss");
    	Date parse=null;
    	try {
    		parse= format.parse("2019-08-08 13:25:00");
		} catch (ParseException e1) {
			System.out.println("time settings failed");
			e1.printStackTrace();
		}
    	System.out.println("执行任务...");
    	//每隔7000秒去获取token
    	timer.schedule(new TimerTask() {
			
			@Override
			public void run() {
//				AceessToken:{"access_token":"24_vHOea_yDrMmoSKwS42bZUN33hrSpY1i_G-C0imRw69cj-1BMMFKRlBHOBVJdf-EcwNrRBWErqfw4l8tzSuy7w_s6If3aLFhG3m5tBv1uIDJ3fEHtf4tiHNWTIqVia5K1imS1u9OY6ZI7dMNhFGLbAJARSX","expires_in":7200}
				String token=null;
				//封装数据
				VxCofig vxCofig = new VxCofig();
				try {
					
					token = WeChat.getJsApiTicketAuto();
				} catch (URISyntaxException e1) {
					// TODO Auto-generated catch block
					e1.printStackTrace();
				}
//				String token = "111";
				System.out.println("the token resultssss:"+token);
				//获取时间戳
				String timestamp = WeChat.getTimestamp();
				System.out.println("the timestamp is:"+timestamp);
				
				String nonStr=WeChat.getNonstr();
				System.out.println("随机串"+nonStr);
				//获取签名
				String signature = WeChat.getSignature(token, timestamp,nonStr);
				
			
				vxCofig.setAppId(WeChat.APPID);
				
				vxCofig.setNonceStr(nonStr);
				vxCofig.setTimestamp(timestamp);
				vxCofig.setSignature(signature);
				if(token==null){
					vxCofig.setJsapiTicket("nullsss");
				}else{
					vxCofig.setJsapiTicket(token);
				}
				vxCofig.setUrl(WeChat.URL);
				//转换成json格式
				Gson gson = new Gson();
				String jsonz = gson.toJson(vxCofig);
				//检测文件是否存在
				//------获取绝对项目的路径
				System.out.println("绝对路径:"+path);
				File file = new File(path, "wx.txt");
				if(!file.exists()){
					//文件不存在创建一个
					try {
						file.createNewFile();
					} catch (IOException e) {
						System.out.println("file creation failed!");
						e.printStackTrace();
					}
				}
				//写入文件
				try {
					System.out.println(token);
					FileOutputStream out = new FileOutputStream(file);
					OutputStreamWriter writer = new OutputStreamWriter(out, "utf-8");
					writer.write(jsonz);
					writer.close();
				} catch (Exception e) {
					System.out.println("write to the file failed!");
					e.printStackTrace();
				} 
				
			}
		}, parse, 7000*1000);
	}
 
}
