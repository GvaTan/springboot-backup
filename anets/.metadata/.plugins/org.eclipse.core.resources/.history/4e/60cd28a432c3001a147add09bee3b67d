/**
 * 
 */
package top.anets.pay.service.impl;

import static org.hamcrest.CoreMatchers.nullValue;

import java.io.Console;
import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.lly835.bestpay.enums.BestPayPlatformEnum;
import com.lly835.bestpay.enums.BestPayTypeEnum;
import com.lly835.bestpay.model.PayRequest;
import com.lly835.bestpay.model.PayResponse;
import com.lly835.bestpay.service.BestPayService;
import lombok.extern.slf4j.Slf4j;
import top.anets.dao.PayInfoDao;
import top.anets.domain.Payinfo;
import top.anets.pay.service.PayService;

/**
 * @author Administrator
 *
 */
@Slf4j
@Transactional
@Service
public class PayServiceImpl implements PayService{
    @Autowired
    private BestPayService bestPayService;
	
    @Autowired
    private PayInfoDao payInfoDao;
	@Override

	public PayResponse create(String orderId, BigDecimal amount,BestPayTypeEnum bestPayTypeEnum) {
		
//		写入数据库
		Payinfo payinfo=new Payinfo();
		payinfo.setOrderId(orderId);
		payinfo.setAmount(amount.doubleValue());
		payinfo.setPayType(bestPayTypeEnum.name());
		payinfo.setCreateTime(new Date());
		payinfo.setStatus((byte)0);
		payInfoDao.insert(payinfo);
		
//		支付请求
		PayRequest payRequest = new PayRequest();
		payRequest.setOrderName("uid-anets");
		payRequest.setOrderId(orderId);
		payRequest.setOrderAmount(amount.doubleValue());
		payRequest.setPayTypeEnum(bestPayTypeEnum);
		
		PayResponse payResponse = bestPayService.pay(payRequest);
		
//		log.info("response={}",payResponse);
		return payResponse;
	}
	
	
	@Override
	public String asynNotify( String  notifyData) {
		System.out.println("支付结果通知");
//		签名校验
		PayResponse payResponse = bestPayService.asyncNotify(notifyData);
		log.info("notifyData={}",payResponse);
		
//		金额校验（从数据库查订单)
		String orderId = payResponse.getOrderId();
		List<Payinfo> orders=payInfoDao.selectByOrderId(orderId);
		Payinfo payinfo = null;
		if(orders!=null&&orders.size()!=0)  payinfo = orders.get(0);
		
//		修改订单状态
		if(payinfo!=null&&payResponse.getOrderAmount().equals(payinfo.getAmount())) {
			log.info("修改订单状态");
			payinfo.setStatus((byte) 1);
			payinfo.setFinishTime(new Date());
            payInfoDao.update(payinfo);			
		}
		

		
//		告诉支付宝/微信不要再重复通知了
		if(payResponse.getPayPlatformEnum()==BestPayPlatformEnum.WX) {
			return "<xml>\n"+
		               " <return_code><![CDATA[SUCCESS]]</return_code>\n"+
				       " <return_msg><![CDATA[OK]]</return_msg>\n"+
		               "</xml>";
		}else if (payResponse.getPayPlatformEnum()==BestPayPlatformEnum.ALIPAY) {
			return "success";
		}
		
			throw new RuntimeException("异步通知中错误的支付平台");
		
		
	}


	@Override
	public Payinfo queryOrder(String orderId) {
		List<Payinfo> list = payInfoDao.selectByOrderId(orderId);
		if(list==null||list.size()==0) return null;
		
		return list.get(0);
	}


	@Override
	public PayResponse create_WxPay_Jsapi(String orderId, BigDecimal amount, BestPayTypeEnum wxpayMini) {
//		支付请求
		PayRequest payRequest = new PayRequest();
		payRequest.setOrderName("uid-anets");
		payRequest.setOrderId(orderId);
		payRequest.setOrderAmount(amount.doubleValue());
		payRequest.setPayTypeEnum(bestPayTypeEnum);
		
		PayResponse payResponse = bestPayService.pay(payRequest);
		
//		log.info("response={}",payResponse);
		return payResponse;
	}

}